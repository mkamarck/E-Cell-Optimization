---
title: "ECell Optimization - First 3 runs"
output: html_document
---

FIRST EXPERIMENT: 7-19-16
No repeats, but every combination was run once with three different concentrations of TMA
Receptor (in ng): 5, 10, 15, 20, 25
SV40 (in ng): 2.5, 5, 10, 15
CRE (in ng): 2.5, 5, 10, 20
The E cell optimization was conduced with hTAAR5 and TMA as this receptor will be used for future E cell experiments. 
The first experiment I ran was prior to much knowledge of how a response surface model worked; therefore, the design of the experiment may not be appropriate for the this part of these following analyses.
In the initial run I looked at luc data alone and RL data, but realized that the only important value is the normData because that is what we will be using for analysis runs in the future. 

```{r}
#libraries
library(ggplot2)
library(reshape2)
library(plyr)
library(rsm)

#import data
df <- read.csv("/Volumes/mainland/Projects/TAARs/E\ cell\ Optimization/Results/ECellOptimization_160719.csv")
df <- df[,1:14]
#split it into parts to look at different data
normData <- df[,c(1:5, 12:14)]
normData_TMA100 <- subset(normData, select = c("Receptor", "SV40", "CRE", "TMA_100_norm"))
#code the receptor, sv40 and CRE into equally spaced variables, example 
#coded.data(ChemReact1, x1 ~ (Time - 85)/5, x2 ~ (Temp - 175)/5)
normTMA_100_coded <- coded.data(normData_TMA100, x1 ~(Receptor-15)/10, x2 ~ (SV40 - 8.75)/6.25, x3 ~ (CRE - 11.25)/8.75)
#rsm models
rsm_testFO <- rsm(TMA_100_norm ~FO(x1,x2,x3), data = normTMA_100_coded)
summary(rsm_testFO)
persp (rsm_testFO, ~x1+ x2 + x3, col = rainbow(50), contours = "colors")
#first order test which shows that the lack of fit is not significant, so its probably an okay model - meaning that we are not near where we need to be
#rsm_testSO <- rsm(TMA_100_norm ~SO(x1,x2,x3), data = normTMA_100_coded)
#summary(rsm_testSO)
#persp (rsm_testSO, ~x1+ x2 + x3, col = rainbow(50), contours = "colors")

#Compare to FO rsm with the other concentrations of TMA
normData_TMA30 <- subset(normData, select = c("Receptor", "SV40", "CRE", "TMA_30_norm"))
normTMA_30_coded <- coded.data(normData_TMA30, x1 ~(Receptor-15)/10, x2 ~ (SV40 - 8.75)/6.25, x3 ~ (CRE - 11.25)/8.75)
rsm_testFO <- rsm(TMA_30_norm ~FO(x1,x2,x3), data = normTMA_30_coded)
summary(rsm_testFO)
persp (rsm_testFO, ~x1+ x2 + x3, col = rainbow(50), contours = "colors")
#this has a significant lack of fit, so look at second order model
rsm_testSO <- rsm(TMA_30_norm ~SO(x1,x2,x3), data = normTMA_30_coded)
summary(rsm_testSO)
persp (rsm_testSO, ~x1+ x2 + x3, col = rainbow(50), contours = "colors")
#now 300
normData_TMA300 <- subset(normData, select = c("Receptor", "SV40", "CRE", "TMA_300_norm"))
normTMA_300_coded <- coded.data(normData_TMA300, x1 ~(Receptor-15)/10, x2 ~ (SV40 - 8.75)/6.25, x3 ~ (CRE - 11.25)/8.75)
rsm_testFO <- rsm(TMA_300_norm ~FO(x1,x2,x3), data = normTMA_300_coded)
summary(rsm_testFO)
persp (rsm_testFO, ~x1+ x2 + x3, col = rainbow(50), contours = "colors")
#this has a significant lack of fit, so look at second order model
rsm_testSO <- rsm(TMA_300_norm ~SO(x1,x2,x3), data = normTMA_300_coded)
summary(rsm_testSO)
persp (rsm_testSO, ~x1+ x2 + x3, col = rainbow(50), contours = "colors")
#all the surface models look similar for these three concentrations.
```
The takeaway from these plots is that the first order model is a good fit, which means that we are not near a place where we are reaching our maximum or minimum values.  
First and second order test show going towards maximum where CRE is high and SV40 is low.  Receptor is less clear but the first order equation suggests that lower receptor is better.
From here, we adjusted the values for the second experiment. At this point a low concentration of receptor did not make sense to me and I thought a lot of that was because I did not design the experiment right. Since our total signal was so low, I had assumed we would need more receptor for the experiment for work better, so I increased the values of receptor. 

SECOND EXPERIMENT: 7-28-16
The main change for the experiment other than different experimental values is the use of each value being run in triplicate.  This allows us to run statistical tests between the three concentrations of TMA. What we are then trying to optimize here is the lowest p value, or the biggest difference between the normalized luc values, which means the DR curve will be the most pronounced.  (we could not conduct t-tests or anovas on the first data set because there was only one datapoint for each test). 
This run was not as optimized as it could have been as I was just learning how to interpret the rsm data. 

Receptor (in ng): 10, 15, 20, 25
SV40 (in ng): 2.5, 5, 10, 15
CRE (in ng): 10, 15, 20

```{r}
#remove everything from previous data
rm(list=ls(all=TRUE))
df <- read.csv("/Volumes/mainland/Projects/TAARs/E\ cell\ Optimization/Results/ECellOptimization_160728.csv")
df <- df[1:96,1:14]
normData <- df[,c(1:5,8,11,14)]
#receptor - middle is 17.5 and difference from middle is 7.5
normData_coded <- coded.data(normData, x1 ~(Receptor-17.5)/7.5, x2 ~ (SV40 - 8.75)/6.25, x3 ~ (CRE - 15)/5)
#rsm analysis - First Order models
#30
norm_30 <- rsm(TMA_30_norm ~ FO(x1,x2,x3), data = normData_coded)
summary(norm_30)
persp(norm_30, ~x1+x2+x3, col = rainbow(50), contours = "colors")
#100
norm_100 <- rsm(TMA_100_norm ~ FO(x1,x2,x3), data = normData_coded)
summary(norm_100)
persp(norm_100, ~x1+x2+x3, col = rainbow(50), contours = "colors")
#300
norm_300 <- rsm(TMA_300_norm ~ FO(x1,x2,x3), data = normData_coded)
summary(norm_300)
persp(norm_300, ~x1+x2+x3, col = rainbow(50), contours = "colors")
```
The lack of fit for the First order model is significant so we used a second order model. 
```{r}
#second order model
#30
norm_30 <- rsm(TMA_30_norm ~ SO(x1,x2,x3), data = normData_coded)
summary(norm_30)
persp(norm_30, ~x1+x2+x3, col = rainbow(50), contours = "colors")
#100
norm_100 <- rsm(TMA_100_norm ~ SO(x1,x2,x3), data = normData_coded)
summary(norm_100)
persp(norm_100, ~x1+x2+x3, col = rainbow(50), contours = "colors")
#300
norm_300 <- rsm(TMA_300_norm ~ SO(x1,x2,x3), data = normData_coded)
summary(norm_300)
persp(norm_300, ~x1+x2+x3, col = rainbow(50), contours = "colors")
```

From these models, I concluded that the receptor value didn't matter much. But I also was able to conduct analyses on the p values of the t-tests I ran. 
```{r}
normData.melt <- melt(normData, c("Row", "Column", "Receptor", "SV40", "CRE"))
normData.melt <- normData.melt[,3:7]
normDatattest_30to100 <- ddply(subset(normData.melt, variable %in% c("TMA_30_norm", "TMA_100_norm")), .variables = c("Receptor", "SV40", "CRE"), function(x) test = t.test(x$value~x$variable)$p.value)

```



You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
